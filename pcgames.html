<!DOCTYPE html>
<html>
    <head>
        <title>Computerspiele</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" type="text/css" href="css/materialize.min.css">
        <link rel="stylesheet" type="text/css" href="css/theme.default.min.css">
        <link rel="stylesheet" type="text/css" href="css/tippy.themes.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
        <script type="text/javascript" src="js/materialize.min.js"></script>
        <script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>
        <script type="text/javascript" src="js/tippy.all.min.js"></script>
        <script type="text/javascript" src="js/Chart.min.js"></script>
        <script type="text/javascript" src="js/rough.min.js"></script>
        <script type="text/javascript" src="js/chartjs-plugin-rough.min.js"></script>
        <script type="text/javascript" src="js/sugar.min.js"></script>
        <script type="text/javascript" src="js/parser-date.min.js"></script>
        <script type="text/javascript" src="js/scroll-button.js"></script>
        <script type="text/javascript">$.fn.extend({toggleText: function(a,b){return this.text(this.text() == b ? a : b);}});</script>
        <script type="text/javascript">
            function parseDate(date) {
                return Sugar.Date(Sugar.Date.create(date.toString())).short('de');
                // return Sugar.Date(Sugar.Date.create(date.toString())).medium('de');
                // return Sugar.Date(Sugar.Date.create(date.toString())).format('{d}. {Mon}. {yyyy}');
            }

            $(document).ready(function() {
                // Formatierung der Datumsangabe für Tablesorter
                Sugar.Date.setLocale('de');

                var chart;

                var request = new XMLHttpRequest();
                request.open('GET', 'pcgames.json', true);
                request.responseType = 'text';
                request.send(null);
                request.onload = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        var pcgames = JSON.parse(request.responseText);
                        for (let i = 0; i < pcgames.length; i++) {
                            var release = pcgames[i]['release'];
                            var release_html = '';
                            if (Array.isArray(release)) {
                                release_html = '<span class="tooltip" title="';
                                for (var j = 0; j < release.length-1; j++) {
                                    release_html += Object.keys(release[j]) + ': ' + parseDate(Object.values(release[j])) + '<br>';
                                }
                                release_html += Object.keys(release[release.length-1]) + ': ' + parseDate(Object.values(release[release.length-1])) + '">' + parseDate(Object.values(release[0])) + '</span>';
                            } else {
                                release_html = parseDate(release);
                            }

                            var title = pcgames[i].hasOwnProperty('link') ? '<a href="' + pcgames[i]['link'] + '">' + pcgames[i]['title'] + '</a>' : pcgames[i]['title'];
                            
                            if (pcgames[i].hasOwnProperty('mod')) {
                                title += ' (' + pcgames[i]['mod'] + ' Mod)';
                            }
                            
                            if (pcgames[i].hasOwnProperty('patch')) {
                                title += '<a href="' + pcgames[i]['patch'] + '"<div class="chip patch">Patch</div></a>';
                            }

                            var genre = Array.isArray(pcgames[i]['genre']) ? pcgames[i]['genre'].join(', ') : pcgames[i]['genre'];

                            var platform = Array.isArray(pcgames[i]['platform']) ? pcgames[i]['platform'] : [pcgames[i]['platform']];
                            var platform_html = '';
                            for (var j = 0; j < platform.length; j++) {
                                if (platform[j] == "Steam") {
                                    platform_html += '<span class="hide">1</span><span class="game-platforms steam" title="Steam"></span>';
                                } else if (platform[j] == "Epic Games") {
                                    platform_html += '<span class="hide">2</span><span class="game-platforms epic-games" title="Epic Games"></span>';
                                } else if (platform[j] == "Uplay") {
                                    platform_html += '<span class="hide">3</span><span class="game-platforms uplay" title="Uplay"></span>';
                                } else if (platform[j] == "Origin") {
                                    platform_html += '<span class="hide">4</span><span class="game-platforms origin" title="Origin"></span>';
                                } else if (platform[j] == "GOG.com") {
                                    platform_html += '<span class="hide">5</span><span class="game-platforms gog" title="GOG.com"></span>';
                                } else if (platform[j] == "Battle.net") {
                                    platform_html += '<span class="hide">6</span><span class="game-platforms battle-net" title="Battle.net"></span>';
                                } else if (platform[j] == "Windows") {
                                    platform_html += '<span class="hide">7</span><span class="game-platforms cd" title="Retail (Windows)"></span>';
                                } else if (platform[j] == "Mac OS") {
                                    platform_html += '<span class="hide">8</span><span class="game-platforms cd" title="Retail (Mac OS)"></span>';
                                } else if (platform[j] == "PlayStation") {
                                    platform_html += '<span class="hide">9</span><span class="game-platforms playstation" title="PlayStation"></span>';
                                } else if (platform[j] == "PlayStation 2") {
                                    platform_html += '<span class="hide">10</span><span class="game-platforms playstation3" title="PlayStation 2"></span>';
                                }
                            }

                            var rating = pcgames[i].hasOwnProperty('rating') ? pcgames[i]['rating'].toString() : "noch nicht gespielt";

                            $('#table > tbody').append('<tr><td>' + release_html + '</td><td>' + title + '</td><td>' + genre + '</td><td>' + platform_html + '</td><td><span class="truncate">' + rating + '</span></td></tr>');
                        }

                        // Tooltips initialisieren
                        tippy("[title]", { placement : "top-start", arrow : true, arrowType : "round", animation : "scale", theme : "translucent" });

                        // Tablesorter initialisieren
                        $('#table').tablesorter({ theme : "default", widthFixed : true, headerTemplate : "{content}{icon}", widgets : ["uitheme"], sortList : [[0,1]] });

                        // Switches und Suchfeld initialisieren
                        $('#switch1').change(function() {
                            searchfilter();
                        });
                        $('#switch2').change(function() {
                            searchfilter();
                        });
                        $('#search').keyup(function() {
                            searchfilter();
                        });
                        $('#clear').click(function() {
                            document.getElementById('search').value = "";
                            searchfilter();
                        });
                        $('#switch1').prop('checked', true);
                        $('#switch2').prop('checked', true);
                        document.getElementById('search').value = "";

                        function searchfilter() {
                            $('#table > tbody').children().hide();
                            var filter_string = $('#search').val().toLowerCase();
                            $('#table > tbody').children().each(function() {
                                if ($(this).children(':last-child').text() != "noch nicht gespielt") {
                                    if ($('#switch1').is(':checked') && $(this).children().text().toLowerCase().indexOf(filter_string) >= 0) {
                                        $(this).show();
                                    }
                                } else {
                                    if ($('#switch2').is(':checked') && $(this).children().text().toLowerCase().indexOf(filter_string) >= 0) {
                                        $(this).show();
                                    }
                                }
                            });
                        }

                        // Bewertung durch Sterne ersetzen
                        $('#table > tbody').children().children(':first-child').addClass('center');
                        $('#table > tbody').children().children(':nth-child(4)').addClass('center');
                        $('#table > tbody').children().children(':last-child').addClass('center');
                        $('#table > tbody').children().each(function() {
                            if ($(this).children(':last-child').text() != "noch nicht gespielt") {
                                var rating = $(this).children(':last-child').text();
                                $(this).children(':last-child').empty();
                                $(this).children(':last-child').append('<span class="hide">' + rating + '</span>');
                                if (rating == '1') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == '1.5') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == '2') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == '2.5') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == '3') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == '3.5') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i>');
                                } else if (rating == '4') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i>');
                                } else if (rating == '4.5') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i>');
                                } else if (rating == '5') {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i>');
                                }
                            }
                        });

                        // Statistiken berechnen
                        var chart_labels = [];
                        var chart_data1 = [];
                        var chart_data2 = [];

                        var year_min = Number.MAX_SAFE_INTEGER;
                        var year_max = Number.MIN_SAFE_INTEGER;

                        $('#table > tbody').children().each(function() {
                            var year = parseInt($(this).children(':nth-child(1)').text().slice(-4));
                            if (year < year_min) year_min = year;
                            if (year > year_max) year_max = year;
                        });

                        for (i = year_min; i <= year_max; i++) {
                            chart_labels.push(i.toString());
                            chart_data1.push(0);
                            chart_data2.push(0);
                        }

                        $('#table > tbody').children().each(function() {
                            var year = $(this).children(':nth-child(1)').text().slice(-4) - year_min;
                            var rating = $(this).children(':last-child').text();
                            if (rating == 'noch nicht gespielt') {
                                chart_data2[year]++;
                            } else {
                                chart_data1[year]++;
                            }
                        });

                        // Globale Einstellungen für Chart.js
                        Chart.defaults.global.defaultFontColor = getComputedStyle(document.body).getPropertyValue('--text-color').trim();
                        Chart.defaults.global.defaultFontFamily = 'Ubuntu';
                        Chart.defaults.global.defaultFontSize = 13;
                        Chart.defaults.global.plugins.rough.roughness = 0;
                        Chart.defaults.global.plugins.rough.bowing = 0;

                        chart = new Chart(
                            document.getElementById('chart').getContext('2d'),
                            {
                                type: 'bar',
                                data: {
                                    labels: chart_labels,
                                    datasets: [{
                                        label: 'Bereits gespielt',
                                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--primary-color-variant').trim(),
                                        borderColor: getComputedStyle(document.body).getPropertyValue('--primary-color').trim(),
                                        borderWidth: 1,
                                        data: chart_data1
                                    }, {
                                        label: 'Noch nicht gespielt',
                                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--secondary-color-variant').trim(),
                                        borderColor: getComputedStyle(document.body).getPropertyValue('--secondary-color').trim(),
                                        borderWidth: 1,
                                        data: chart_data2
                                    }],
                                },
                                options: {
                                    legend: {
                                        position: 'top'
                                    },
                                    scales: {
                                        xAxes: [{
                                            stacked: true
                                        }],
                                        yAxes: [{
                                            stacked: true
                                        }]
                                    },
                                    tooltips: {
                                        mode: 'index'
                                    }
                                },
                                plugins: [ChartRough]
                            }
                        );
                    }
                }

                // Dark/Light Theme toggle
                $('#toggle-theme').click(function() {
                    document.documentElement.toggleAttribute('light-theme');
                    $('#theme-icon').toggleText('wb_sunny', 'brightness_2');
                    Chart.defaults.global.defaultFontColor = getComputedStyle(document.body).getPropertyValue('--text-color').trim();
                    chart.update();
                });
            });
        </script>
    </head>

    <body>
        <nav class="nav-extended">
            <div class="nav-wrapper">
                <span class="brand-logo">Computerspiele</span>
                <ul class="right">
                    <li><a href="#" id="toggle-theme"><i class="material-icons" id="theme-icon">wb_sunny</i></a></li>
                </ul>
            </div>
        </nav>

        <div class="container">
            <div class="row">
                <div class="col s12 m12 l8 xl7">
                    <div class="switch">
                        <label>Aus<input type="checkbox" id="switch1"><span class="lever"></span>An</label>
                        <span class="switch-description">Bereits gespielte Spiele anzeigen</span>
                    </div>
                    <div class="switch">
                        <label>Aus<input type="checkbox" id="switch2"><span class="lever"></span>An</label>
                        <span class="switch-description">Noch nicht gespielte Spiele anzeigen</span>
                    </div>
                </div>
                <div class="col s12 m12 l4 xl5">
                    <div class="input-field">
                        <i class="material-icons prefix">search</i>
                        <input id="search" type="search">
                        <label for="search">Suchfilter</label>
                        <i class="material-icons" id="clear">close</i>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <table class="bordered tablesorter" id="table">
                        <thead>
                            <tr>
                                <th class="sorter-sugar">Release</th>
                                <th>Titel</th>
                                <th>Genre</th>
                                <th>Plattform</th>
                                <th class="sorter-digit string-bottom">Bewertung</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <canvas id="chart"></canvas>
                </div>
            </div>
        </div>
    </body>
</html>
