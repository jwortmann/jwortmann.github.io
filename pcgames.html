<!DOCTYPE html>
<html>
    <head>
        <title>Computerspiele</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Ubuntu">
        <link rel="stylesheet" type="text/css" href="css/materialize.min.css">
        <link rel="stylesheet" type="text/css" href="css/theme.default.min.css">
        <link rel="stylesheet" type="text/css" href="css/brands.min.css">
        <link rel="stylesheet" type="text/css" href="css/fontawesome.min.css">
        <link rel="stylesheet" type="text/css" href="css/tippy.themes.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="js/materialize.min.js"></script>
        <script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>
        <script type="text/javascript" src="js/tippy.all.min.js"></script>
        <script type="text/javascript" src="js/Chart.min.js"></script>

        <script type="text/javascript">
            $(document).ready(function() {
                var request = new XMLHttpRequest();
                request.open('GET', 'pcgames.json', true);
                request.responseType = 'text';
                request.send(null);
                request.onload = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        var json_obj = JSON.parse(request.responseText);
                        var pcgames = json_obj['pcgames'];
                        for (var i = 0; i < pcgames.length; i++) {
                            var release = pcgames[i]['release'];
                            var release_html = '';
                            if (Array.isArray(release)) {
                                release_html = '<span class="tooltip" title="';
                                for (var j = 0; j < release.length-1; j++) {
                                    release_html += Object.keys(release[j]) + ': ' + Object.values(release[j]) + '<br>';
                                }
                                release_html += Object.keys(release[release.length-1]) + ': ' + Object.values(release[release.length-1]) + '">' + Object.values(release[0]) + '</span>';
                            } else {
                                release_html = release;
                            }
                            var title = pcgames[i]['title'];
                            var genre = pcgames[i]['genre'];
                            var platform = '';
                            if (pcgames[i]['platform'] == "Windows") {
                                platform = '<span class="fab fa-windows" title="Windows"></span>';
                            } else if (pcgames[i]['platform'] == "Steam") {
                                platform = '<span class="fab fa-steam" title="Steam"></span>';
                            } else if (pcgames[i]['platform'] == "Origin") {
                                platform = '<span class="fab fa-windows" title="Origin"></span>';
                            } else if (pcgames[i]['platform'] == "Uplay") {
                                platform = '<span class="fab fa-windows" title="Uplay"></span>';
                            } else if (pcgames[i]['platform'] == "PlayStation") {
                                platform = '<span class="fab fa-playstation" title="PlayStation"></span>';
                            } else if (pcgames[i]['platform'] == "PlayStation 2") {
                                platform = '<span class="fab fa-playstation" title="PlayStation 2"></span>';
                            }
                            var rating = "noch nicht gespielt";
                            if (pcgames[i].hasOwnProperty('rating')) {
                                rating = pcgames[i]['rating'].toString();
                            }
                            $('table#pcgames > tbody').append("<tr><td>" + release_html + "</td><td>" + title + "</td><td>" + genre + "</td><td>" + platform + "</td><td>" + rating + "</td></tr>");
                        }
                        $('table').tablesorter({theme : "default", widthFixed : true, headerTemplate : "{content}{icon}", widgets : ["uitheme"], sortList : [[0,1]]});
                        $(function(){tippy("[title]", {placement : "top-start", arrow : true, arrowType : "round", animation : "scale", theme : "translucent"})})

                        // Switches und Suchfeld initialisieren
                        $('#switch1').change(function() {
                            searchfilter();
                        });
                        $('#switch2').change(function() {
                            searchfilter();
                        });
                        $('#search').keyup(function() {
                            searchfilter();
                        });
                        $('#clear').click(function() {
                            document.getElementById('search').value = "";
                            searchfilter();
                        });
                        $('#switch1').prop('checked', true);
                        $('#switch2').prop('checked', true);
                        document.getElementById('search').value = "";

                        function searchfilter() {
                            $('tbody').children().hide();
                            $('tbody').children().each(function() {
                                if ($(this).children(':last-child').text() != "noch nicht gespielt") {
                                    if ($('#switch1').is(':checked') && $(this).children().text().toLowerCase().indexOf($('#search').val().toLowerCase()) >= 0) {
                                        $(this).show();
                                    }
                                } else {
                                    if ($('#switch2').is(':checked') && $(this).children().text().toLowerCase().indexOf($('#search').val().toLowerCase()) >= 0) {
                                        $(this).show();
                                    }
                                }
                            });
                        }

                        // Bewertung durch Sterne ersetzen
                        $('tbody').children().children(':first-child').addClass('center');
                        $('tbody').children().children(':nth-child(4)').addClass('center');
                        $('tbody').children().children(':last-child').addClass('center');
                        $('tbody').children().each(function() {
                            if ($(this).children(':last-child').text() != "noch nicht gespielt") {
                                var rating = $(this).children(':last-child').text();
                                $(this).children(':last-child').empty();
                                $(this).children(':last-child').append('<span class="hide">' + rating + '</span>');
                                if (rating == "1") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "1.5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "2") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "2.5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "3") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "3.5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i>');
                                } else if (rating == "4") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i>');
                                } else if (rating == "4.5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i>');
                                } else if (rating == "5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i>');
                                }
                            }
                        });

                        // Statistiken berechnen und darstellen
                        Chart.defaults.global.defaultFontColor = getComputedStyle(document.body).getPropertyValue('--text-color').trim();
                        Chart.defaults.global.defaultFontFamily = "Ubuntu";
                        Chart.defaults.global.defaultFontSize = 13;

                        $('#main').append('<h1>Statistiken</h1>');
                        $('#main').append('<h3>Spiele nach Jahr</h3><canvas id="chart1" />');
                        $('#main').append('<h3>Spiele nach Bewertung</h3><canvas id="chart2" />');

                        var chart1_labels = [];
                        var chart1_data1 = [];
                        var chart1_data2 = [];
                        var chart2_data = [0, 0, 0, 0, 0, 0, 0, 0, 0];

                        var year_min = Number.MAX_SAFE_INTEGER;
                        var year_max = Number.MIN_SAFE_INTEGER;

                        $('tbody').children().each(function() {
                            var year = parseInt($(this).children(':nth-child(1)').text().slice(-4));
                            if (year < year_min) year_min = year;
                            if (year > year_max) year_max = year;
                        });

                        for (i = year_min; i <= year_max; i++) {
                            chart1_labels.push(i.toString());
                            chart1_data1.push(0);
                            chart1_data2.push(0);
                        }

                        $('tbody').children().each(function() {
                            var year = $(this).children(':nth-child(1)').text().slice(-4) - year_min;
                            var rating = $(this).children(':last-child').text()
                            if (rating == "noch nicht gespielt") {
                                chart1_data2[year]++;
                            } else {
                                chart1_data1[year]++;
                                chart2_data[10 - 2*parseFloat(rating)]++;
                            }
                        });

                        var chart1 = new Chart(
                            document.getElementById("chart1").getContext("2d"),
                            {
                                type: 'bar',
                                data: {
                                    labels: chart1_labels,
                                    datasets: [{
                                        label: 'Bereits gespielt',
                                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--light-primary-color').trim(),
                                        borderColor: getComputedStyle(document.body).getPropertyValue('--primary-color').trim(),
                                        borderWidth: 1,
                                        data: chart1_data1
                                    }, {
                                        label: 'Noch nicht gespielt',
                                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--light-secondary-color').trim(),
                                        borderColor: getComputedStyle(document.body).getPropertyValue('--secondary-color').trim(),
                                        borderWidth: 1,
                                        data: chart1_data2
                                    }],
                                },
                                options: {
                                    legend: {
                                        position: 'top'
                                    },
                                    tooltips: {
                                        mode: 'index',
                                        intersect: false
                                    },
                                    scales: {
                                        xAxes: [{
                                            stacked: true
                                        }],
                                        yAxes: [{
                                            stacked: true
                                        }]
                                    }
                                }
                            }
                        );

                        var chart2 = new Chart(
                            document.getElementById("chart2").getContext("2d"),
                            {
                                type: 'horizontalBar',
                                data: {
                                    labels: ["\ue838\ue838\ue838\ue838\ue838", "\ue838\ue838\ue838\ue838\ue839", "\ue838\ue838\ue838\ue838\ue83a", "\ue838\ue838\ue838\ue839\ue83a", "\ue838\ue838\ue838\ue83a\ue83a", "\ue838\ue838\ue839\ue83a\ue83a", "\ue838\ue838\ue83a\ue83a\ue83a", "\ue838\ue839\ue83a\ue83a\ue83a", "\ue838\ue83a\ue83a\ue83a\ue83a"],
                                    datasets: [{
                                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--light-primary-color').trim(),
                                        borderColor: getComputedStyle(document.body).getPropertyValue('--primary-color').trim(),
                                        borderWidth: 1,
                                        data: chart2_data
                                    }]
                                },
                                options: {
                                    scales: {
                                        yAxes: [{
                                            ticks: {
                                                fontFamily: 'Material Icons',
                                                fontSize: 20
                                            }
                                        }]
                                    },
                                    legend: {
                                        display: false
                                    },
                                    tooltips: {
                                        titleFontFamily: 'Material Icons',
                                        titleFontSize: 16,
                                        titleFontStyle: 'lighter'
                                    }
                                }
                            }
                        );
                    }
                }

                // Scroll-Button
                $('body').append('<a href="#top" id="scroll-top"><span class="btn-floating"><i class="material-icons">keyboard_arrow_up</i></span></a>');
                $('#scroll-top').hide();
                $(function() {
                    $(window).scroll(function() {
                        if ($(this).scrollTop() > 100) {
                            $('#scroll-top').fadeIn();
                        } else {
                            $('#scroll-top').fadeOut();
                        }
                    });
                    $('#scroll-top').click(function() {
                        $('body,html').animate({
                            scrollTop: 0
                        }, 800);
                        return false;
                    });
                });
            });
        </script>

        <style type="text/css">
            h3 {
                color: #666;
            }
            th {
                text-align: center;
            }
        </style>
    </head>

    <body>
        <div class="container" style="width: 80%">
            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content" id="main">
                            <h1 style="margin-top: -0.1em">Computerspiele</h1>

                            <div class="row">
                                <div class="col l6 m12">
                                    <div class="switch">
                                        <label>
                                            Aus
                                            <input type="checkbox" id="switch1">
                                            <span class="lever"></span>
                                            An
                                        </label>
                                        <span style="margin-left: 2em">Bereits gespielte Spiele anzeigen</span>
                                    </div>
                                    <div class="switch">
                                        <label>
                                            Aus
                                            <input type="checkbox" id="switch2">
                                            <span class="lever"></span>
                                            An
                                        </label>
                                        <span style="margin-left: 2em">Noch nicht gespielte Spiele anzeigen</span>
                                    </div>
                                </div>
                                <div class="input-field col l6 m12" style="margin-top: 0">
                                    <i class="material-icons prefix">search</i>
                                    <input id="search" type="search">
                                    <label for="search">Suchfilter</label>
                                    <i class="material-icons" id="clear">close</i>
                                </div>
                            </div>

                            <table class="bordered tablesorter dark" id="pcgames">
                                <thead>
                                    <tr><th class="dateFormat-ddmmyyyy">Release</th><th>Titel</th><th>Genre</th><th class="sorter-false">Plattform</th><th class="sorter-digit string-bottom">Bewertung</th></tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
