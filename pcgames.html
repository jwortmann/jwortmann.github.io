<!DOCTYPE html>
<html>
    <head>
        <title>Computerspiele</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" type="text/css" href="css/materialize.min.css">
        <link rel="stylesheet" type="text/css" href="css/theme.default.min.css">
        <link rel="stylesheet" type="text/css" href="css/brands.min.css">
        <link rel="stylesheet" type="text/css" href="css/fontawesome.min.css">
        <link rel="stylesheet" type="text/css" href="css/tippy.themes.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="js/materialize.min.js"></script>
        <script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>
        <script type="text/javascript" src="js/tippy.all.min.js"></script>
        <script type="text/javascript" src="js/Chart.min.js"></script>
        <script type="text/javascript" src="js/sugar.min.js"></script>
        <script type="text/javascript" src="js/parser-date.min.js"></script>
        <script type="text/javascript">$(document).ready(function(){$('.tabs').tabs();});</script>
        <script type="text/javascript">
            function parseDate(date) {
                return Sugar.Date(Sugar.Date.create(date.toString())).short('de');
                // return Sugar.Date(Sugar.Date.create(date.toString())).medium('de');
                // return Sugar.Date(Sugar.Date.create(date.toString())).format('{d}. {Mon}. {yyyy}');
            }
        </script>
        <script type="text/javascript">
            $(document).ready(function() {
                // Formatierung der Datumsangabe f√ºr Tablesorter
                Sugar.Date.setLocale('de');

                var request = new XMLHttpRequest();
                request.open('GET', 'pcgames.json', true);
                request.responseType = 'text';
                request.send(null);
                request.onload = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        var json_obj = JSON.parse(request.responseText);
                        var pcgames = json_obj['pcgames'];
                        for (var i = 0; i < pcgames.length; i++) {
                            var release = pcgames[i]['release'];
                            var release_html = '';
                            if (Array.isArray(release)) {
                                release_html = '<span class="tooltip" title="';
                                for (var j = 0; j < release.length-1; j++) {
                                    release_html += Object.keys(release[j]) + ': ' + parseDate(Object.values(release[j])) + '<br>';
                                }
                                release_html += Object.keys(release[release.length-1]) + ': ' + parseDate(Object.values(release[release.length-1])) + '">' + parseDate(Object.values(release[0])) + '</span>';
                            } else {
                                release_html = parseDate(release);
                            }
                            var title = '';
                            if (pcgames[i].hasOwnProperty('link')) {
                                title = '<a href="' + pcgames[i]['link'] + '">' + pcgames[i]['title'] + '</a>'
                            } else {
                                title = pcgames[i]['title'];
                            }
                            if (pcgames[i].hasOwnProperty('mod')) {
                                title += '<div class="chip mod">' + pcgames[i]['mod'] + ' Mod</div>';
                            }
                            if (pcgames[i].hasOwnProperty('patch')) {
                                title += '<a href="' + pcgames[i]['patch'] + '"<div class="chip patch">Patch</div></a>';
                            }
                            var genre = pcgames[i]['genre'];
                            var platform = '';
                            if (pcgames[i]['platform'] == "Windows") {
                                platform = '<span class="fab fa-windows" title="Retail (Windows)"></span>';
                            } else if (pcgames[i]['platform'] == "Mac OS") {
                                platform = '<span class="fab fa-apple" title="Retail (Mac OS)"></span>';
                            } else if (pcgames[i]['platform'] == "Steam") {
                                platform = '<span class="fab fa-steam" title="Steam"></span>';
                            } else if (pcgames[i]['platform'] == "GOG") {
                                platform = '<span class="fab fa-windows" title="GOG"></span>';
                            } else if (pcgames[i]['platform'] == "Origin") {
                                platform = '<span class="game-platforms origin" title="Origin"></span>';
                            } else if (pcgames[i]['platform'] == "Uplay") {
                                platform = '<span class="game-platforms uplay" title="Uplay"></span>';
                            } else if (pcgames[i]['platform'] == "Battle.net") {
                                platform = '<span class="game-platforms battle-net" title="Battle.net"></span>';
                            } else if (pcgames[i]['platform'] == "PlayStation") {
                                platform = '<span class="fab fa-playstation" title="PlayStation"></span>';
                            } else if (pcgames[i]['platform'] == "PlayStation 2") {
                                platform = '<span class="fab fa-playstation" title="PlayStation 2"></span>';
                            } else if (pcgames[i]['platform'] == "Xbox") {
                                platform = '<span class="fab fa-xbox" title="Xbox"></span>';
                            }
                            var rating = "noch nicht gespielt";
                            if (pcgames[i].hasOwnProperty('rating')) {
                                rating = pcgames[i]['rating'].toString();
                            }
                            $('table#pcgames > tbody').append("<tr><td>" + release_html + "</td><td>" + title + "</td><td>" + genre + "</td><td>" + platform + "</td><td>" + rating + "</td></tr>");
                        }

                        // Tooltips initialisieren
                        tippy("[title]", { placement : "top-start", arrow : true, arrowType : "round", animation : "scale", theme : "translucent" });
                        
                        // Tablesorter initialisieren
                        $('table').tablesorter({ theme : "default", widthFixed : true, headerTemplate : "{content}{icon}", widgets : ["uitheme"], sortList : [[0,1]] });

                        // Switches und Suchfeld initialisieren
                        $('#switch1').change(function() {
                            searchfilter();
                        });
                        $('#switch2').change(function() {
                            searchfilter();
                        });
                        $('#search').keyup(function() {
                            searchfilter();
                        });
                        $('#clear').click(function() {
                            document.getElementById('search').value = "";
                            searchfilter();
                        });
                        $('#switch1').prop('checked', true);
                        $('#switch2').prop('checked', true);
                        document.getElementById('search').value = "";

                        function searchfilter() {
                            $('tbody').children().hide();
                            var filter_string = $('#search').val().toLowerCase();
                            $('tbody').children().each(function() {
                                if ($(this).children(':last-child').text() != "noch nicht gespielt") {
                                    if ($('#switch1').is(':checked') && $(this).children().text().toLowerCase().indexOf(filter_string) >= 0) {
                                        $(this).show();
                                    }
                                } else {
                                    if ($('#switch2').is(':checked') && $(this).children().text().toLowerCase().indexOf(filter_string) >= 0) {
                                        $(this).show();
                                    }
                                }
                            });
                        }

                        // Bewertung durch Sterne ersetzen
                        $('tbody').children().children(':first-child').addClass('center');
                        $('tbody').children().children(':nth-child(4)').addClass('center');
                        $('tbody').children().children(':last-child').addClass('center');
                        $('tbody').children().each(function() {
                            if ($(this).children(':last-child').text() != "noch nicht gespielt") {
                                var rating = $(this).children(':last-child').text();
                                $(this).children(':last-child').empty();
                                $(this).children(':last-child').append('<span class="hide">' + rating + '</span>');
                                if (rating == "1") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "1.5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "2") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "2.5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "3") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i><i class="material-icons">star_border</i>');
                                } else if (rating == "3.5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i><i class="material-icons">star_border</i>');
                                } else if (rating == "4") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_border</i>');
                                } else if (rating == "4.5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star_half</i>');
                                } else if (rating == "5") {
                                    $(this).children(':last-child').append('<i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i><i class="material-icons">star</i>');
                                }
                            }
                        });

                        // Statistiken berechnen und darstellen
                        Chart.defaults.global.defaultFontColor = getComputedStyle(document.body).getPropertyValue('--text-color').trim();
                        Chart.defaults.global.defaultFontFamily = "Ubuntu";
                        Chart.defaults.global.defaultFontSize = 13;

                        var chart1_labels = [];
                        var chart1_data1 = [];
                        var chart1_data2 = [];
                        var chart2_data = [0, 0];
                        // var chart3_data = [0, 0, 0, 0, 0, 0, 0, 0, 0];

                        var year_min = Number.MAX_SAFE_INTEGER;
                        var year_max = Number.MIN_SAFE_INTEGER;

                        $('tbody').children().each(function() {
                            var year = parseInt($(this).children(':nth-child(1)').text().slice(-4));
                            if (year < year_min) year_min = year;
                            if (year > year_max) year_max = year;
                        });

                        for (i = year_min; i <= year_max; i++) {
                            chart1_labels.push(i.toString());
                            chart1_data1.push(0);
                            chart1_data2.push(0);
                        }

                        $('tbody').children().each(function() {
                            var year = $(this).children(':nth-child(1)').text().slice(-4) - year_min;
                            var rating = $(this).children(':last-child').text();
                            if (rating == "noch nicht gespielt") {
                                chart1_data2[year]++;
                                chart2_data[1]++;
                            } else {
                                chart1_data1[year]++;
                                chart2_data[0]++;
                                // chart3_data[10 - 2*parseFloat(rating)]++;
                            }
                        });

                        var chart1 = new Chart(
                            document.getElementById("chart1").getContext("2d"),
                            {
                                type: 'bar',
                                data: {
                                    labels: chart1_labels,
                                    datasets: [{
                                        label: 'Bereits gespielt',
                                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--light-primary-color').trim(),
                                        borderColor: getComputedStyle(document.body).getPropertyValue('--primary-color').trim(),
                                        borderWidth: 1,
                                        data: chart1_data1
                                    }, {
                                        label: 'Noch nicht gespielt',
                                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--light-secondary-color').trim(),
                                        borderColor: getComputedStyle(document.body).getPropertyValue('--secondary-color').trim(),
                                        borderWidth: 1,
                                        data: chart1_data2
                                    }],
                                },
                                options: {
                                    legend: {
                                        position: 'top'
                                    },
                                    tooltips: {
                                        mode: 'index',
                                        intersect: false
                                    },
                                    scales: {
                                        xAxes: [{
                                            stacked: true
                                        }],
                                        yAxes: [{
                                            stacked: true
                                        }]
                                    }
                                }
                            }
                        );

                        var chart2 = new Chart(
                            document.getElementById("chart2").getContext("2d"),
                            {
                                type: 'doughnut',
                                data: {
                                    labels: [
                                        'Bereits gespielt',
                                        'Noch nicht gespielt'
                                    ],
                                    datasets: [{
                                        backgroundColor: [
                                            getComputedStyle(document.body).getPropertyValue('--light-primary-color').trim(),
                                            getComputedStyle(document.body).getPropertyValue('--light-secondary-color').trim()
                                        ],
                                        borderColor: [
                                            getComputedStyle(document.body).getPropertyValue('--primary-color').trim(),
                                            getComputedStyle(document.body).getPropertyValue('--secondary-color').trim()
                                        ],
                                        borderWidth: [1, 1],
                                        data: chart2_data
                                    }]
                                },
                                options: {
                                    legend: {
                                        position: 'top'
                                    }
                                }
                            }
                        );

                        // var chart3 = new Chart(
                        //     document.getElementById("chart3").getContext("2d"),
                        //     {
                        //         type: 'horizontalBar',
                        //         data: {
                        //             labels: ["\ue838\ue838\ue838\ue838\ue838", "\ue838\ue838\ue838\ue838\ue839", "\ue838\ue838\ue838\ue838\ue83a", "\ue838\ue838\ue838\ue839\ue83a", "\ue838\ue838\ue838\ue83a\ue83a", "\ue838\ue838\ue839\ue83a\ue83a", "\ue838\ue838\ue83a\ue83a\ue83a", "\ue838\ue839\ue83a\ue83a\ue83a", "\ue838\ue83a\ue83a\ue83a\ue83a"],
                        //             datasets: [{
                        //                 backgroundColor: getComputedStyle(document.body).getPropertyValue('--light-primary-color').trim(),
                        //                 borderColor: getComputedStyle(document.body).getPropertyValue('--primary-color').trim(),
                        //                 borderWidth: 1,
                        //                 data: chart3_data
                        //             }]
                        //         },
                        //         options: {
                        //             scales: {
                        //                 yAxes: [{
                        //                     ticks: {
                        //                         fontFamily: 'Material Icons',
                        //                         fontSize: 20
                        //                     }
                        //                 }]
                        //             },
                        //             legend: {
                        //                 display: false
                        //             },
                        //             tooltips: {
                        //                 titleFontFamily: 'Material Icons',
                        //                 titleFontSize: 16,
                        //                 titleFontStyle: 'lighter'
                        //             }
                        //         }
                        //     }
                        // );
                    }
                }

                // Scroll-Button
                $('#scroll-top').hide();
                $(function() {
                    $(window).scroll(function() {
                        if ($(this).scrollTop() > 100) {
                            $('#scroll-top').fadeIn();
                        } else {
                            $('#scroll-top').fadeOut();
                        }
                    });
                    $('#scroll-top').click(function() {
                        $('body,html').animate({
                            scrollTop: 0
                        }, 800);
                        return false;
                    });
                });
            });
        </script>
    </head>

    <body>
        <nav class="nav-extended">
            <div class="nav-wrapper">
                <span class="brand-logo">Computerspiele</span>
                <!-- <ul class="right">
                    <li><a href="#" id="switch-theme"><i class="material-icons">palette</i></a></li>
                </ul> -->
            </div>
            <div class="nav-content">
                <ul class="tabs tabs-transparent">
                    <li class="tab col s12"><a href="#games">Spiele</a></li>
                    <li class="tab col s12"><a href="#stats">Statistiken</a></li>
                </ul>
            </div>
        </nav>

        <div id="games" class="container">
            <div class="row">
                <div class="col s12 l6">
                    <div class="switch">
                        <label>Aus<input type="checkbox" id="switch1"><span class="lever"></span>An</label>
                        <span class="switch-description">Bereits gespielte Spiele anzeigen</span>
                    </div>
                    <div class="switch">
                        <label>Aus<input type="checkbox" id="switch2"><span class="lever"></span>An</label>
                        <span class="switch-description">Noch nicht gespielte Spiele anzeigen</span>
                    </div>
                </div>
                <div class="col s12 l6">
                    <div class="input-field">
                        <i class="material-icons prefix">search</i>
                        <input id="search" type="search">
                        <label for="search">Suchfilter</label>
                        <i class="material-icons" id="clear">close</i>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <table class="bordered tablesorter" id="pcgames">
                        <thead>
                            <tr>
                                <!-- <th class="dateFormat-ddmmyyyy">Release</th> -->
                                <th class="sorter-sugar">Release</th>
                                <th>Titel</th>
                                <th>Genre</th>
                                <th class="sorter-false">Plattform</th>
                                <th class="sorter-digit string-bottom">Bewertung</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="stats" class="container">
            <div class="row">
                <div class="col s12">
                    <h2>Spiele nach Jahr</h2>
                    <canvas id="chart1"></canvas>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <h2>Anteil bereits gespielter Spiele</h2>
                    <canvas id="chart2"></canvas>
                </div>
            </div>
            <!-- <div class="row">
                <div class="col s12">
                    <h2>Spiele nach Bewertung</h2>
                    <canvas id="chart3"></canvas>
                </div>
            </div> -->
        </div>

        <a href="#top" id="scroll-top">
            <span class="btn-floating">
                <i class="material-icons">keyboard_arrow_up</i>
            </span>
        </a>
    </body>
</html>